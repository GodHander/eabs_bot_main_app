<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /> -->
    <title></title>
    <script type="text/javascript">
    	
		// 扩展API是否准备好，如果没有则监听“plusready"事件  
		if(window.plus){  
			plusReady();  
		}else{   
			document.addEventListener( "plusready", plusReady, false );  
		}  
		// 扩展API准备完成后要执行的操作  
		function plusReady(){  
			var ws = plus.webview.currentWebview(); //pw回车可输出plus.webview  
			console.warn('检测到plusReady!');
		}
		
    </script>
	
	<link href="./css/index.css" rel="stylesheet" type="text/css"/>

</head>

<body>
	<script src="js/scratch-vm.js"></script>
	<script src="js/scratch-storage.js"></script>
	<script src="js/scratch-svg-renderer.js"></script>
	<script src="js/scratch-render.js"></script>
	<script src="js/dist.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	
	<div id="mainGroup" class="flexColumnWrap mainContent">
		<canvas id="paintPlayer" class="playerCanvas"></canvas>
		<div id="webTestGrp" class="flexRowWrap" style="display: none;">
			<label>前端自测：</label>
			<button id="btn_autoPlay" class="testBtn">加载(AutoPlay)</button>
			<button id="btn_EvtFindPersonCome" class="testBtn">发现人来</button>
			<button id="btn_EvtFindPersonLeave" class="testBtn">发现人走</button>
			<button id="btn_evn" class="testBtn">是否PC平台</button>
		</div>
		
		<div id="otherCallBtnGrp" class="flexRowWrap">
			<label>安卓接口调用：</label>
			<button id="btn_RobotTTS" class="testBtn">语音播报测试</button>
		</div>
		
		<div class="flexColumnWrap" class="fullW" style="background-color: darkcyan;">
			<label id="showResult">日志记录</label>
			<textarea id="logArea" readonly="true" class="fullW" style="height: 12.5rem; background-color: beige;"></textarea>
		</div>
	</div>
	
	<script>
			// 日志
			function logMsg (msg) {
				let textNode = document.createTextNode(msg + '\r\n');
				document.getElementById('logArea').appendChild(textNode);
			}
		
			/**
			 * 检测平台
			 */
			function environmentCheck () {
				//平台、设备和操作系统
				let system = { win: false, mac: false, xll: false, ipad: false };
				//检测平台
				let p = navigator.platform;
				system.win = p.indexOf("Win") == 0;
				system.mac = p.indexOf("Mac") == 0;
				system.x11 = (p == "X11") || (p.indexOf("Linux") == 0);
				system.ipad = (navigator.userAgent.match(/iPad/i) != null) ? true : false;
				//跳转语句，如果是手机访问就自动跳转到" "里的页面
				if (system.win || system.mac || system.xll || system.ipad) {
					return true;
				} else {
					return false;
				}
			}
			
			/**
			 * Base64字符串 ---> ArrayBuffer
			 */
			function base64ToArrayBuffer(base64String) {
				var byteString = window.atob(base64String); //base64 解码
				console.warn('base64解码后长度：', byteString.length);
				
				var arrayBuffer = new ArrayBuffer(byteString.length); //创建缓冲数组
				var intArray = new Uint8Array(arrayBuffer); //创建视图
				for (var i = 0; i < byteString.length; i++) {
					intArray[i] = byteString.charCodeAt(i);
				}
				return intArray;
			}
			
			/**
			 * Base64字符串 ---> Blob
			 */
			function base64ToBlob(base64String) {
				var mimeString = 'application/octet-stream'; // mime类型
				var byteString = window.atob(base64String); //base64 解码
				console.warn('base64解码后长度：', byteString.length);
				
				var arrayBuffer = new ArrayBuffer(byteString.length); //创建缓冲数组
				var intArray = new Uint8Array(arrayBuffer); //创建视图
				for (var i = 0; i < byteString.length; i++) {
					intArray[i] = byteString.charCodeAt(i);
				}
				return new Blob([intArray], {type: mimeString});
			}
			
			/**
			 * 调用播放器内接口 - 提供给主应用App的接口
			 */
			function callJsMethod (funcName, paramStr, projectData) {
				logMsg(`主应用请求调用播放器接口: ${funcName}, 参数: ${paramStr}`);
				if (funcName === 'loadNewProjectFile') {
					if (projectData instanceof ArrayBuffer) {
						logMsg('文件数据为ArrayBuffer类型');
						if (projectData) {
							vm.callJsMethod(funcName, paramStr, projectData);
						} else {
							logMsg('文件数据为空！');
						}
					} else if (typeof projectData === 'string') {
						logMsg('文件数据为Base64加密字符串');
						if (projectData === 'undefined' || projectData === '' || projectData === 'null') {
							logMsg('文件数据为空！');
							return;
						}
						// 方式一: Blob
// 						let fileBlob = base64ToBlob(base64Str);
// 						console.warn(fileBlob);
// 						var reader = new FileReader();
// 						reader.readAsArrayBuffer(fileBlob);
// 						reader.onload = (e) => {
// 							console.info(reader.result); //ArrayBuffer {}
// 							vm.callJsMethod('loadNewProjectFile', paramStr, reader.result);
// 						}
						// 方式二: 直接ArrayBuffer
						let fileArrayBuffer = base64ToArrayBuffer(projectData);
						logMsg(`转换后的ArrayBuffer的长度:`, fileArrayBuffer.length);
						vm.callJsMethod(funcName, paramStr, fileArrayBuffer);
					} else {
						logMsg('文件数据为其他类型');
						if (!projectData) {
							logMsg('文件数据为空！默认为byteArray类型');
							return;
						}
						let byteArrayBlob = new Blob([projectData], {type: 'application/octet-stream'});
						var byteArrayReader = new FileReader();
						byteArrayReader.readAsArrayBuffer(byteArrayBlob);
						reader.onload = () => {
							vm.callJsMethod(funcName, paramStr, byteArrayReader.result);
						}
					}
				} else {
					vm.callJsMethod(funcName, paramStr);
				}
			}
	
			/**
			 * 向播放器发送事件 - 提供给主应用App的接口
			 */
			function appEventHandler (evtName, evtParamStr) {
				logMsg(`主应用发来事件: ${evtName}`);
				vm.appEventHandler(evtName, evtParamStr);
			}
			
			/**
			 * 调用主应用App内的接口 - 提供给播放器内使用
			 */
			function _callNativeMethod (funcName, paramStr) {
				logMsg(`请求调用主应用的接口: ${funcName}, 参数是 ${paramStr}`);
				window.android.callAndroidMethod(funcName, paramStr);
			}
			
			/**
			 * 向主应用App内发送事件 - 提供给播放器内使用
			 */
			function _dispatchPlayerEvent(evtName, evtParamStr) {
				if (evtName === 'logEvent') {
					logMsg(evtParamStr);
				} else {
					logMsg(`向主应用发送事件: ${evtName}, 参数是 ${evtParamStr}`);
					window.android.playerEventHandler(evtName, evtParamStr);
				}
			}
			
	        // These variables are going to be available in the "window global" intentionally.
	        // Allows you easy access to debug with `vm.greenFlag()` etc.
	        window.devicePixelRatio = 1;
	
	        var canvas = document.getElementById('paintPlayer');
	        var render = new ScratchRender(canvas);
	        var vm = new VirtualMachine();
	        var storage = new ScratchStorage();
			var audio = new AudioEngine();
	        var mockMouse = data => vm.runtime.postIOData('mouse', {
	            canvasWidth: canvas.width,
	            canvasHeight: canvas.height,
				...data
	        });
	
	        vm.attachStorage(storage);
	        vm.attachRenderer(render);
			vm.attachAudioEngine(audio);
	        vm.attachV2SVGAdapter(new ScratchSVGRenderer.SVGRenderer());
	        vm.attachV2BitmapAdapter(new ScratchSVGRenderer.BitmapAdapter());
			// initAppPlatformService 接口调用后,播放器内部将使用本地App服务,不调用会默认使用远程(Socket形式)
			vm.initAppPlatformService(_callNativeMethod, _dispatchPlayerEvent);
	
	
			// 模拟主应用 - 加载文件 - 自动播放
			document.getElementById('btn_autoPlay').addEventListener('click', e => {
				axios.get('img/ScratchAndroid.sb3', { responseType: 'arraybuffer' })
				.then(response => {
					console.log(response);
					vm.callJsMethod('loadNewProjectFile', JSON.stringify({autoPlay: true}), response.data);
				})
			})
			// 模拟主应用 - 向播放器发送 '发现人来' 事件
			document.getElementById('btn_EvtFindPersonCome').addEventListener('click', e=> {
				appEventHandler('findPersonCome', JSON.stringify({name: 'barry', identity: 'student'}));
			});
			// 模拟主应用 - 向播放器发送 '发现人走' 事件
			document.getElementById('btn_EvtFindPersonLeave').addEventListener('click', e=> {
				appEventHandler('findPersonLeave', '');
			});
			
			
			// 调用主应用 '语音播报' 事件
			document.getElementById('btn_RobotTTS').addEventListener('click', e=> {
				_callNativeMethod('robotTTS', JSON.stringify({text:"这是语音播报测试文字"}));
			});
			
			
			// 测试运行平台
			document.getElementById('btn_evn').addEventListener('click', e=> {
				if (environmentCheck()) {
					logMsg('当前平台为PC端！')
				} else {
					logMsg('当前平台为移动端！');
				}
			});

	</script>
</body>
</html>